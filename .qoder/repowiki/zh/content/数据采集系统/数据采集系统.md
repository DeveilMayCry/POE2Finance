# 数据采集系统

<cite>
**本文档引用的文件**
- [BaseDataCollector.cs](file://src\POE2Finance.Services\DataCollection\BaseDataCollector.cs)
- [TencentOfficialCollector.cs](file://src\POE2Finance.Services\DataCollection\Collectors\TencentOfficialCollector.cs)
- [DD373Collector.cs](file://src\POE2Finance.Services\DataCollection\Collectors\DD373Collector.cs)
- [AntiBanHttpClient.cs](file://src\POE2Finance.Services\Infrastructure\AntiBanHttpClient.cs)
- [MaintenanceJobs.cs](file://src\POE2Finance.Services\Jobs\MaintenanceJobs.cs)
- [DataCollectionConfiguration.cs](file://src\POE2Finance.Services\Configuration\DataCollectionConfiguration.cs)
- [DataCollectionService.cs](file://src\POE2Finance.Services\DataCollection\DataCollectionService.cs)
</cite>

## 目录
1. [数据采集模块设计概述](#数据采集模块设计概述)
2. [BaseDataCollector抽象类设计](#basedatacollector抽象类设计)
3. [具体数据源采集器实现](#具体数据源采集器实现)
   - [腾讯官方采集器](#腾讯官方采集器)
   - [DD373采集器](#dd373采集器)
4. [反封禁HTTP客户端实现](#反封禁http客户端实现)
5. [数据采集调度机制](#数据采集调度机制)
6. [容错处理机制](#容错处理机制)
7. [多数据源配置与采集频率调整](#多数据源配置与采集频率调整)
8. [数据去重与一致性校验](#数据去重与一致性校验)

## 数据采集模块设计概述

数据采集模块是POE2Finance系统的核心组件，负责从多个外部数据源获取游戏货币价格信息。该模块采用分层架构设计，包含抽象基类、具体实现、反封禁机制、调度系统和配置管理等多个部分。通过这种设计，系统能够灵活地扩展新的数据源，同时确保采集过程的稳定性和可靠性。

**本节来源**
- [BaseDataCollector.cs](file://src\POE2Finance.Services\DataCollection\BaseDataCollector.cs)
- [DataCollectionService.cs](file://src\POE2Finance.Services\DataCollection\DataCollectionService.cs)

## BaseDataCollector抽象类设计

BaseDataCollector作为数据采集器的抽象基类，定义了通用的采集流程和接口规范。该类实现了IDataCollector接口，为所有具体的数据源采集器提供了统一的契约。

```mermaid
classDiagram
class IDataCollector {
<<interface>>
+DataSource DataSource
+int Priority
+bool IsEnabled
+Task<bool> ValidateAsync(CancellationToken)
+Task<PriceDataDto?> CollectPriceAsync(CurrencyType, CancellationToken)
+Task<List<PriceDataDto>> CollectAllPricesAsync(CancellationToken)
}
class BaseDataCollector {
<<abstract>>
-ILogger _logger
+abstract DataSource DataSource
+abstract int Priority
+abstract bool IsEnabled
+virtual Task<bool> ValidateAsync(CancellationToken)
+virtual Task<PriceDataDto?> CollectPriceAsync(CurrencyType, CancellationToken)
+virtual Task<List<PriceDataDto>> CollectAllPricesAsync(CancellationToken)
+protected Task<bool> PerformValidationAsync(CancellationToken)
+protected Task<PriceDataDto?> PerformPriceCollectionAsync(CurrencyType, CancellationToken)
+protected Task<List<PriceDataDto>> PerformAllPricesCollectionAsync(CancellationToken)
+protected PriceDataDto CreatePriceDataDto(CurrencyType, decimal, decimal, string, int?)
+protected static string GetCurrencyDisplayName(CurrencyType)
+protected static decimal ConvertToExaltedPrice(decimal, CurrencyType, decimal)
}
IDataCollector <|.. BaseDataCollector
```

**图表来源**
- [BaseDataCollector.cs](file://src\POE2Finance.Services\DataCollection\BaseDataCollector.cs#L9-L47)
- [BaseDataCollector.cs](file://src\POE2Finance.Services\DataCollection\BaseDataCollector.cs#L52-L216)

**本节来源**
- [BaseDataCollector.cs](file://src\POE2Finance.Services\DataCollection\BaseDataCollector.cs)

## 具体数据源采集器实现

### 腾讯官方采集器

TencentOfficialCollector实现了对腾讯官方POE2交易平台的数据采集。该采集器继承自BaseDataCollector，通过API接口获取数据，具有较高的数据准确性和稳定性。

```mermaid
sequenceDiagram
participant Collector as TencentOfficialCollector
participant HttpClient as ResilientHttpClient
participant API as 腾讯官方API
Collector->>Collector : PerformPriceCollectionAsync()
Collector->>HttpClient : GetJsonWithRetryAsync()
HttpClient->>API : GET /api/trade?item={itemId}
API-->>HttpClient : 返回JSON数据
HttpClient-->>Collector : 解析响应
Collector->>Collector : ParseTencentResponse()
Collector-->>Collector : 返回PriceDataDto
```

**图表来源**
- [TencentOfficialCollector.cs](file://src\POE2Finance.Services\DataCollection\Collectors\TencentOfficialCollector.cs#L13-L158)
- [TencentOfficialCollector.cs](file://src\POE2Finance.Services\DataCollection\Collectors\TencentOfficialCollector.cs#L59-L86)

**本节来源**
- [TencentOfficialCollector.cs](file://src\POE2Finance.Services\DataCollection\Collectors\TencentOfficialCollector.cs)

### DD373采集器

DD373Collector实现了对DD373平台的数据采集。由于该平台主要提供HTML页面，因此采集器使用HtmlAgilityPack库进行网页解析，通过选择器定位价格信息。

```mermaid
flowchart TD
Start([开始采集]) --> LoadHTML["加载DD373网页HTML"]
LoadHTML --> FindPriceNode["查找价格节点<br/>多种选择器尝试"]
FindPriceNode --> PriceNodeFound{"找到节点?"}
PriceNodeFound --> |否| ReturnNull["返回null"]
PriceNodeFound --> |是| ExtractPriceText["提取价格文本"]
ExtractPriceText --> ParsePrice["解析价格数值"]
ParsePrice --> PriceParsed{"解析成功?"}
PriceParsed --> |否| ReturnNull
PriceParsed --> |是| ConvertToExalted["转换为崇高石计价"]
ConvertToExalted --> GetVolume["获取交易量"]
GetVolume --> CreateDTO["创建PriceDataDto"]
CreateDTO --> End([返回结果])
```

**图表来源**
- [DD373Collector.cs](file://src\POE2Finance.Services\DataCollection\Collectors\DD373Collector.cs#L15-L234)
- [DD373Collector.cs](file://src\POE2Finance.Services\DataCollection\Collectors\DD373Collector.cs#L62-L89)

**本节来源**
- [DD373Collector.cs](file://src\POE2Finance.Services\DataCollection\Collectors\DD373Collector.cs)

## 反封禁HTTP客户端实现

AntiBanHttpClient类实现了多种反封禁策略，确保数据采集过程不会被目标网站识别和阻止。该类通过请求节流、随机延迟和User-Agent轮换等技术实现反反爬虫功能。

```mermaid
classDiagram
class AntiBanHttpClient {
-HttpClient _httpClient
-ILogger _logger
-DataCollectionConfiguration _config
-Random _random
-SemaphoreSlim _rateLimitSemaphore
-DateTime _lastRequestTime
+Task<HttpResponseMessage> GetAsync(string, Dictionary, CancellationToken)
+Task<string> GetStringAsync(string, Dictionary, CancellationToken)
+Task<T?> GetJsonAsync<T>(string, Dictionary, CancellationToken)
-Task EnsureRateLimitAsync(CancellationToken)
-Task AddRandomDelayAsync(CancellationToken)
-void SetRandomUserAgent(HttpRequestMessage)
}
class ResilientHttpClient {
-AntiBanHttpClient _client
-ILogger _logger
-DataCollectionConfiguration _config
+Task<string?> GetStringWithRetryAsync(string, Dictionary, CancellationToken)
+Task<T?> GetJsonWithRetryAsync<T>(string, Dictionary, CancellationToken)
-IAsyncPolicy CreateRetryPolicy()
}
ResilientHttpClient --> AntiBanHttpClient : "使用"
```

**图表来源**
- [AntiBanHttpClient.cs](file://src\POE2Finance.Services\Infrastructure\AntiBanHttpClient.cs#L12-L178)
- [AntiBanHttpClient.cs](file://src\POE2Finance.Services\Infrastructure\AntiBanHttpClient.cs#L183-L272)

**本节来源**
- [AntiBanHttpClient.cs](file://src\POE2Finance.Services\Infrastructure\AntiBanHttpClient.cs)

## 数据采集调度机制

系统通过Quartz.NET框架实现数据采集的定时调度。MaintenanceJobs类中的DataCollectionJob负责定期执行数据采集任务，确保价格数据的及时更新。

```mermaid
sequenceDiagram
participant Scheduler as Quartz调度器
participant Job as DataCollectionJob
participant Service as DataCollectionService
participant Collector as IDataCollector
participant DB as 数据库
Scheduler->>Job : Execute()
Job->>Service : CheckAllDataSourcesHealthAsync()
Service->>Collector : ValidateAsync()
Collector-->>Service : 健康状态
Service-->>Job : 健康状态汇总
Job->>Service : CollectPriceWithFallbackAsync()
Service->>Collector : CollectPriceAsync()
Collector-->>Service : 价格数据
Service-->>Job : 价格数据
Job->>DB : 批量插入价格数据
DB-->>Job : 插入结果
Job-->>Scheduler : 任务完成
```

**图表来源**
- [MaintenanceJobs.cs](file://src\POE2Finance.Services\Jobs\MaintenanceJobs.cs#L12-L120)
- [DataCollectionService.cs](file://src\POE2Finance.Services\DataCollection\DataCollectionService.cs#L116-L148)

**本节来源**
- [MaintenanceJobs.cs](file://src\POE2Finance.Services\Jobs\MaintenanceJobs.cs)

## 容错处理机制

系统实现了多层次的容错处理机制，包括异常捕获、重试策略和数据源故障转移。当某个数据源不可用时，系统会自动切换到备用数据源，确保数据采集的连续性。

```mermaid
flowchart TD
Start([开始采集]) --> CheckHealth["检查数据源健康状态"]
CheckHealth --> Healthy{"数据源健康?"}
Healthy --> |否| TryNext["尝试下一个数据源"]
Healthy --> |是| CollectData["采集数据"]
CollectData --> Success{"采集成功?"}
Success --> |否| LogError["记录错误日志"]
Success --> |是| ReturnData["返回数据"]
LogError --> Retry["执行重试策略"]
Retry --> RetryCount{"达到最大重试次数?"}
RetryCount --> |否| CollectData
RetryCount --> |是| TryNext
TryNext --> HasNext{"还有其他数据源?"}
HasNext --> |否| ReturnNull["返回null"]
HasNext --> |是| CheckHealth
ReturnData --> End([结束])
ReturnNull --> End
```

**图表来源**
- [DataCollectionService.cs](file://src\POE2Finance.Services\DataCollection\DataCollectionService.cs#L116-L148)
- [AntiBanHttpClient.cs](file://src\POE2Finance.Services\Infrastructure\AntiBanHttpClient.cs#L209-L251)

**本节来源**
- [DataCollectionService.cs](file://src\POE2Finance.Services\DataCollection\DataCollectionService.cs)
- [AntiBanHttpClient.cs](file://src\POE2Finance.Services\Infrastructure\AntiBanHttpClient.cs)

## 多数据源配置与采集频率调整

系统通过DataCollectionConfiguration类实现多数据源的配置管理。用户可以通过配置文件调整各个数据源的优先级、启用状态和采集频率。

```mermaid
erDiagram
DATA_COLLECTION_CONFIG {
int CollectionIntervalHours
int MinRequestIntervalSeconds
int RequestTimeoutSeconds
int MaxRetries
int RetryDelayBaseSeconds
List<string> UserAgents
}
DATA_SOURCE_CONFIG {
bool Enabled
int Priority
string BaseUrl
Dictionary<string, string> Headers
}
TENCENT_CONFIG {
string TradeApiEndpoint
}
DD373_CONFIG {
string Poe2Section
}
DATA_COLLECTION_CONFIG ||--o{ DATA_SOURCE_CONFIG : "包含"
DATA_SOURCE_CONFIG }|--|| TENCENT_CONFIG : "继承"
DATA_SOURCE_CONFIG }|--|| DD373_CONFIG : "继承"
```

**图表来源**
- [DataCollectionConfiguration.cs](file://src\POE2Finance.Services\Configuration\DataCollectionConfiguration.cs#L5-L58)
- [DataCollectionConfiguration.cs](file://src\POE2Finance.Services\Configuration\DataCollectionConfiguration.cs#L105-L173)

**本节来源**
- [DataCollectionConfiguration.cs](file://src\POE2Finance.Services\Configuration\DataCollectionConfiguration.cs)

## 数据去重与一致性校验

系统通过多种机制确保数据的一致性和准确性。首先，在数据采集层面，系统会验证数据源的健康状态；其次，在数据存储层面，系统会进行数据去重和有效性检查。

```mermaid
flowchart TD
Start([开始数据处理]) --> ValidateSource["验证数据源健康状态"]
ValidateSource --> SourceValid{"数据源有效?"}
SourceValid --> |否| SkipCollection["跳过采集"]
SourceValid --> |是| CollectData["采集数据"]
CollectData --> CheckDuplicate["检查数据重复"]
CheckDuplicate --> IsDuplicate{"数据重复?"}
IsDuplicate --> |是| UpdateExisting["更新现有记录"]
IsDuplicate --> |否| InsertNew["插入新记录"]
InsertNew --> ValidateConsistency["验证数据一致性"]
ValidateConsistency --> Consistent{"数据一致?"}
Consistent --> |否| FlagInvalid["标记为无效"]
Consistent --> |是| MarkValid["标记为有效"]
MarkValid --> End([完成])
FlagInvalid --> End
UpdateExisting --> End
SkipCollection --> End
```

**图表来源**
- [MaintenanceJobs.cs](file://src\POE2Finance.Services\Jobs\MaintenanceJobs.cs#L12-L120)
- [DataCollectionService.cs](file://src\POE2Finance.Services\DataCollection\DataCollectionService.cs)

**本节来源**
- [MaintenanceJobs.cs](file://src\POE2Finance.Services\Jobs\MaintenanceJobs.cs)
- [DataCollectionService.cs](file://src\POE2Finance.Services\DataCollection\DataCollectionService.cs)