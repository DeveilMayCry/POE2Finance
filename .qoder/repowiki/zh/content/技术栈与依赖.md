# 技术栈与依赖

<cite>
**本文档中引用的文件**  
- [Program.cs](file://src/POE2Finance.Web/Program.cs)
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json)
- [AutomatedAnalysisJob.cs](file://src/POE2Finance.Services/Jobs/AutomatedAnalysisJob.cs)
- [EdgeTtsService.cs](file://src/POE2Finance.Services/AI/EdgeTtsService.cs)
- [VideoCreationService.cs](file://src/POE2Finance.Services/Video/VideoCreationService.cs)
- [ChartGenerationService.cs](file://src/POE2Finance.Services/Charts/ChartGenerationService.cs)
- [PriceAnalysisService.cs](file://src/POE2Finance.Services/Analysis/PriceAnalysisService.cs)
- [BilibiliPublishingService.cs](file://src/POE2Finance.Services/Publishing/BilibiliPublishingService.cs)
- [POE2FinanceDbContext.cs](file://src/POE2Finance.Data/DbContexts/POE2FinanceDbContext.cs)
- [CurrencyPriceRepository.cs](file://src/POE2Finance.Data/Repositories/CurrencyPriceRepository.cs)
- [AnalysisConfiguration.cs](file://src/POE2Finance.Services/Configuration/AnalysisConfiguration.cs)
- [VideoConfiguration.cs](file://src/POE2Finance.Services/Configuration/VideoConfiguration.cs)
- [ChartConfiguration.cs](file://src/POE2Finance.Services/Configuration/ChartConfiguration.cs)
- [BilibiliConfiguration.cs](file://src/POE2Finance.Services/Configuration/BilibiliConfiguration.cs)
- [POE2Finance.Web.csproj](file://src/POE2Finance.Web/POE2Finance.Web.csproj)
- [POE2Finance.Services.csproj](file://src/POE2Finance.Services/POE2Finance.Services.csproj)
</cite>

## 目录
1. [技术栈概览](#技术栈概览)  
2. [.NET 9.0 运行时环境](#net-90-运行时环境)  
3. [Entity Framework Core 与 SQLite 数据库](#entity-framework-core-与-sqlite-数据库)  
4. [Quartz.NET 定时任务调度](#quartznet-定时任务调度)  
5. [Serilog 结构化日志记录](#serilog-结构化日志记录)  
6. [Swashbuckle.AspNetCore API 文档](#swashbuckleaspnetcore-api-文档)  
7. [FFMpegCore 视频合成](#ffmpegcore-视频合成)  
8. [ScottPlot 价格趋势图表](#scottplot-价格趋势图表)  
9. [Edge-TTS 语音合成](#edge-tts-语音合成)  
10. [技术协同与核心流程](#技术协同与核心流程)  
11. [版本信息与配置方式](#版本信息与配置方式)  
12. [技术选型权衡考量](#技术选型权衡考量)

## 技术栈概览

POE2Finance 项目采用现代化 .NET 技术栈构建，围绕自动化市场分析与视频生成的核心功能，整合了多种高性能第三方库。系统基于 .NET 9.0 构建，利用其卓越的性能和跨平台能力。数据持久化采用 Entity Framework Core 操作 SQLite 数据库，确保轻量级与高效性。后台任务调度由 Quartz.NET 实现，支持精确的定时分析任务。Serilog 提供结构化日志记录，便于监控与调试。API 文档通过 Swashbuckle.AspNetCore 自动生成。视频合成依赖 FFMpegCore，图表生成使用 ScottPlot，语音合成则通过 Edge-TTS 实现。这些技术协同工作，实现了从数据采集、分析、内容生成到视频发布的一体化流程。

## .NET 9.0 运行时环境

.NET 9.0 作为本项目的核心运行时环境，提供了卓越的性能、安全性和开发效率。作为最新的长期支持（LTS）版本，.NET 9.0 在运行时性能、内存管理和垃圾回收方面进行了显著优化，这对于处理大量价格数据和生成高分辨率视频等计算密集型任务至关重要。其跨平台特性确保了应用可以在 Windows、Linux 和 macOS 上无缝部署。项目采用 ASP.NET Core Web API 架构，充分利用了 .NET 9.0 的依赖注入、配置系统和中间件管道，构建了模块化、可测试的后端服务。.NET 9.0 的 AOT（Ahead-of-Time）编译等新特性也为未来性能优化提供了可能。

**Section sources**
- [Program.cs](file://src/POE2Finance.Web/Program.cs#L1-L146)

## Entity Framework Core 与 SQLite 数据库

项目使用 Entity Framework Core (EF Core) 作为对象关系映射（ORM）框架，与 SQLite 数据库协同工作。EF Core 提供了强大的 LINQ 查询能力、变更跟踪和迁移功能，极大地简化了数据库操作。在 `POE2FinanceDbContext.cs` 中，定义了 `CurrencyMetadata`、`CurrencyPrice`、`AnalysisReport` 和 `VideoRecord` 等实体的数据库上下文，并通过 `OnModelCreating` 方法配置了主键、索引和外键关系。例如，`CurrencyPrice` 实体与 `CurrencyMetadata` 通过 `CurrencyType` 建立了外键关联。

SQLite 被选为数据库引擎，主要因其轻量级、零配置和文件型数据库的特性。它非常适合本项目作为单机应用或小型服务的场景，无需独立的数据库服务器，降低了部署复杂度和资源消耗。在 `appsettings.json` 中，连接字符串 `"Data Source=poe2finance.db"` 明确指定了 SQLite 数据库文件。EF Core 的 `SaveChangesAsync` 方法被重写以自动管理 `CreatedAt` 和 `UpdatedAt` 时间戳，确保了数据的完整性。

**Section sources**
- [POE2FinanceDbContext.cs](file://src/POE2Finance.Data/DbContexts/POE2FinanceDbContext.cs#L1-L178)
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L1-L131)

## Quartz.NET 定时任务调度

Quartz.NET 是项目中实现自动化任务调度的核心组件。在 `Program.cs` 的 DI 容器配置中，通过 `AddQuartz` 和 `AddQuartzHostedService` 注册了 Quartz 服务。系统定义了多个定时任务，均在 `AutomatedAnalysisJob.cs` 中实现，该任务实现了 `IJob` 接口，并被 `DisallowConcurrentExecution` 属性标记以防止并发执行。

具体调度策略如下：
- **上午场分析任务**：每天 09:00 执行，Cron 表达式为 `0 0 9 * * ?`。
- **下午场分析任务**：每天 15:00 执行。
- **晚间场分析任务**：每天 21:00 执行。
- **数据采集任务**：每小时执行一次，但仅在 08:00 至 23:00 之间运行，Cron 表达式为 `0 0 8-23 * * ?`。
- **清理任务**：每天凌晨 02:00 执行，用于清理过期数据。

这些任务通过 `JobDataMap` 传递 `TimeSlot` 参数，实现了不同时间段的差异化分析。Quartz.NET 的可靠性和灵活性确保了市场分析报告能够准时生成和发布。

**Section sources**
- [Program.cs](file://src/POE2Finance.Web/Program.cs#L50-L118)
- [AutomatedAnalysisJob.cs](file://src/POE2Finance.Services/Jobs/AutomatedAnalysisJob.cs#L15-L350)

## Serilog 结构化日志记录

Serilog 为项目提供了强大的结构化日志记录能力。在 `Program.cs` 中，通过 `Log.Logger` 配置和 `UseSerilog` 将 Serilog 集成到 ASP.NET Core 的日志系统中。详细的配置位于 `appsettings.json` 的 `Serilog` 节点下。

日志被同时输出到控制台和文件。文件日志配置为按天滚动（`rollingInterval: Day`），保留最近 7 天的日志文件，路径为 `logs/poe2finance-.log`。输出模板包含了时间戳、日志级别、消息和异常堆栈，便于问题追踪。日志级别被精细控制：默认为 `Information`，`Microsoft` 和 `System` 命名空间下的日志被降级为 `Warning`，而 `Quartz` 相关日志则保持 `Information` 级别，确保了日志的清晰和重点突出。

**Section sources**
- [Program.cs](file://src/POE2Finance.Web/Program.cs#L7-L13)
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L115-L131)

## Swashbuckle.AspNetCore API 文档

Swashbuckle.AspNetCore 用于自动生成和提供 Swagger API 文档。在 `Program.cs` 中，通过 `AddEndpointsApiExplorer` 和 `AddSwaggerGen` 添加了 Swagger 生成器。在开发环境（`IsDevelopment`）下，通过 `UseSwagger` 和 `UseSwaggerUI` 启用了 Swagger UI 界面。

这使得开发者和 API 使用者可以通过一个交互式的 Web 界面（通常位于 `/swagger` 路径）来浏览所有可用的 API 端点、查看请求/响应模型、尝试调用 API 并查看返回结果。这一功能极大地提升了 API 的可发现性和易用性，是现代 Web API 开发的标准实践。

**Section sources**
- [Program.cs](file://src/POE2Finance.Web/Program.cs#L43-L48)

## FFMpegCore 视频合成

FFMpegCore 是一个 .NET 的 FFmpeg 封装库，用于视频的编码、解码和处理。在 `VideoCreationService.cs` 中，它被用来将一系列 PNG 图片帧和 MP3 音频文件合成为最终的 MP4 视频。

具体流程如下：首先，使用 `FFMpegArguments` 将按序命名的图片帧（如 `frame_%06d.png`）转换为一个临时视频流，设置帧率为 30 FPS，并使用 `libx264` 编码器。然后，将生成的临时视频与通过 Edge-TTS 生成的音频文件进行合并，再次使用 `libx264` 和 `aac` 编码器，生成最终的带音轨视频。`WithConstantRateFactor(23)` 等参数确保了视频质量与文件大小的平衡。

**Section sources**
- [VideoCreationService.cs](file://src/POE2Finance.Services/Video/VideoCreationService.cs#L350-L400)

## ScottPlot 价格趋势图表

ScottPlot 是一个高性能的 .NET 图表库，用于生成价格趋势图和热点物品对比图。在 `ChartGenerationService.cs` 中，`GeneratePriceTrendChartAsync` 方法使用 ScottPlot 的 `Plot` 类来创建图表。

该服务将 `PriceDataDto` 列表中的时间戳和价格数据转换为 X 和 Y 轴坐标，为每种通货（如崇高石、神圣石）绘制不同颜色的折线图，并添加图例。图表的外观（如背景色、网格线、字体大小）通过 `ChartConfiguration` 进行配置。最终，图表被保存为 PNG 图片文件，这些图片随后被 `VideoCreationService` 用作视频的素材。

**Section sources**
- [ChartGenerationService.cs](file://src/POE2Finance.Services/Charts/ChartGenerationService.cs#L50-L180)

## Edge-TTS 语音合成

Edge-TTS 服务通过调用命令行工具 `edge-tts` 实现文本到语音的转换。在 `EdgeTtsService.cs` 中，`GenerateAudioAsync` 方法是核心。

该方法首先对输入文本进行预处理，包括替换特殊字符、处理数字读音、统一通货名称等。然后，将处理后的文本写入一个临时文件，并构建调用 `edge-tts` 命令行的参数，如指定语音（`zh-CN-XiaoxiaoNeural`）、语速（`+10%`）和输出文件。通过 `ProcessStartInfo` 启动进程并捕获输出，最终生成 MP3 格式的音频文件。此音频文件作为旁白，与图表一起被合成为最终的视频。

**Section sources**
- [EdgeTtsService.cs](file://src/POE2Finance.Services/AI/EdgeTtsService.cs#L50-L150)

## 技术协同与核心流程

各技术栈协同工作，形成了一个完整的自动化分析与发布流水线。整个流程始于 Quartz.NET 触发 `AutomatedAnalysisJob`。该任务首先通过 `DataCollectionService` 收集最新价格数据，并持久化到 SQLite 数据库（通过 EF Core）。接着，`PriceAnalysisService` 读取历史数据，计算趋势和热度，生成市场分析报告。

随后，`ChartGenerationService` (ScottPlot) 根据分析结果生成多张 PNG 图表。`EdgeTtsService` 将分析报告的文本内容合成为 MP3 音频。最后，`VideoCreationService` (FFMpegCore) 将这些图片帧和音频文件合成为最终的 MP4 视频。视频生成后，`BilibiliPublishingService` 通过 B 站 API 将视频上传并发布。Serilog 记录了整个流程的每一步，而 Swashbuckle 提供了所有服务接口的文档。

**Section sources**
- [AutomatedAnalysisJob.cs](file://src/POE2Finance.Services/Jobs/AutomatedAnalysisJob.cs#L15-L350)

## 版本信息与配置方式

项目主要依赖库的版本信息如下：
- **.NET SDK**: 9.0
- **Entity Framework Core**: 8.0.8 (由 .NET 9.0 SDK 隐式引用)
- **Quartz**: 3.13.1
- **Serilog**: 8.0.2 (Serilog.AspNetCore)
- **Swashbuckle.AspNetCore**: 6.8.1
- **FFMpegCore**: 5.1.0
- **ScottPlot**: 5.0.51
- **Edge-TTS**: 通过命令行工具调用，版本未在项目中直接指定

配置方式主要通过 `appsettings.json` 文件和 `IOptions<T>` 模式实现。每个服务（如 `AnalysisConfiguration`, `VideoConfiguration`）都有对应的配置类，并在 `Program.cs` 中通过 `Configure<T>` 方法注入。服务通过依赖注入获取配置实例，实现了配置与代码的解耦。

**Section sources**
- [POE2Finance.Web.csproj](file://src/POE2Finance.Web/POE2Finance.Web.csproj#L14-L20)
- [POE2Finance.Services.csproj](file://src/POE2Finance.Services/POE2Finance.Services.csproj#L19-L20)
- [Program.cs](file://src/POE2Finance.Web/Program.cs#L30-L41)
- [AnalysisConfiguration.cs](file://src/POE2Finance.Services/Configuration/AnalysisConfiguration.cs#L1-L161)
- [VideoConfiguration.cs](file://src/POE2Finance.Services/Configuration/VideoConfiguration.cs#L1-L438)
- [ChartConfiguration.cs](file://src/POE2Finance.Services/Configuration/ChartConfiguration.cs#L1-L252)
- [BilibiliConfiguration.cs](file://src/POE2Finance.Services/Configuration/BilibiliConfiguration.cs#L1-L438)

## 技术选型权衡考量

选择 SQLite 而非 MySQL 或 PostgreSQL 等更强大的数据库，主要基于以下权衡：
1.  **部署简易性**：SQLite 是一个嵌入式数据库，无需独立的数据库服务器进程，所有数据存储在一个文件中，极大地简化了部署和维护。
2.  **资源消耗低**：对于本项目的数据量和并发需求，SQLite 的性能完全足够，且占用内存和 CPU 资源极少。
3.  **开发便捷**：开发和测试时无需配置数据库服务器，开箱即用。
4.  **单用户场景**：项目主要作为自动化脚本运行，写入操作由单个进程控制，避免了 SQLite 在高并发写入时的性能瓶颈。

尽管 SQLite 在高并发和复杂事务处理上不如客户端-服务器数据库，但其在本项目的应用场景下，是轻量、高效且可靠的最佳选择。其他技术选型也遵循了类似原则：选择成熟、稳定、社区活跃且能精准解决特定问题的库，而非追求最复杂或最流行的方案。

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L4-L6)