# 部署与配置

<cite>
**本文档中引用的文件**   
- [Dockerfile](file://Dockerfile)
- [docker-compose.yml](file://docker-compose.yml)
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json)
- [DEPLOYMENT.md](file://DEPLOYMENT.md)
- [DataCollectionConfiguration.cs](file://src/POE2Finance.Services/Configuration/DataCollectionConfiguration.cs)
- [AnalysisConfiguration.cs](file://src/POE2Finance.Services/Configuration/AnalysisConfiguration.cs)
- [ChartConfiguration.cs](file://src/POE2Finance.Services/Configuration/ChartConfiguration.cs)
- [BilibiliConfiguration.cs](file://src/POE2Finance.Services/Configuration/BilibiliConfiguration.cs)
- [ContentGenerationConfiguration.cs](file://src/POE2Finance.Services/Configuration/ContentGenerationConfiguration.cs)
- [VideoConfiguration.cs](file://src/POE2Finance.Services/Configuration/VideoConfiguration.cs)
- [Program.cs](file://src/POE2Finance.Web/Program.cs)
</cite>

## 目录
1. [Docker镜像构建](#docker镜像构建)
2. [Docker Compose部署](#docker-compose部署)
3. [应用配置详解](#应用配置详解)
4. [环境变量覆盖](#环境变量覆盖)
5. [多环境配置最佳实践](#多环境配置最佳实践)
6. [健康检查与监控](#健康检查与监控)

## Docker镜像构建

Dockerfile采用多阶段构建策略，确保生产环境镜像的轻量化和安全性。基础镜像选用官方的.NET 9 Runtime，构建镜像使用.NET 9 SDK。

### 基础镜像与依赖安装
第一阶段（`base`）使用`mcr.microsoft.com/dotnet/aspnet:9.0`作为基础镜像，暴露8080和8081端口。通过`apt-get`安装FFmpeg、Python3及必需的中文字体包（`fonts-wqy-zenhei`和`fonts-wqy-microhei`），并使用`pip3`安装Edge-TTS语音合成工具。

### 构建与发布阶段
第二阶段（`build`）使用`mcr.microsoft.com/dotnet/sdk:9.0`镜像，复制项目文件并执行`dotnet restore`恢复NuGet包。随后复制全部源码，使用`dotnet build`进行编译，并在`publish`阶段通过`dotnet publish`生成发布版本。

### 最终镜像配置
最终阶段（`final`）基于`base`镜像，复制发布文件，并创建`/app/logs`、`/app/data`和`/app/temp`目录用于日志、数据和临时文件存储。设置`ASPNETCORE_ENVIRONMENT`为`Production`，并配置`HEALTHCHECK`指令，通过curl命令定期检查`/health`端点以确保服务健康。

**Section sources**
- [Dockerfile](file://Dockerfile#L1-L68)

## Docker Compose部署

docker-compose.yml定义了应用服务和可选的Nginx反向代理服务，支持本地部署和测试。

### 主应用服务
`poe2finance`服务基于项目根目录的Dockerfile构建，容器名为`poe2finance-app`，设置为`unless-stopped`重启策略。将主机的8080端口映射到容器的8080端口，并通过环境变量设置ASP.NET Core环境和URL。使用卷（volumes）将主机的`./data`、`./logs`和`./temp`目录挂载到容器对应路径，确保数据持久化。

### 健康检查配置
服务定义了健康检查，测试命令为`["CMD", "curl", "-f", "http://localhost:8080/health"]`，每30秒检查一次，超时10秒，重试3次，启动后等待40秒再开始检查。

### Nginx反向代理（可选）
`nginx`服务使用`nginx:alpine`镜像，将主机的80和443端口映射到容器。通过卷挂载自定义的`nginx.conf`配置文件和SSL证书。`depends_on`确保Nginx在主应用启动后才启动。

### 网络与卷
定义了名为`poe2finance-network`的桥接网络，供服务间通信。声明了`poe2finance-data`和`poe2finance-logs`两个卷，可用于更精细的数据管理。

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L49)

## 应用配置详解

`appsettings.json`文件包含应用的核心配置，通过依赖注入在服务中使用。

### DataCollection配置节
`DataCollection`节控制数据采集行为。`CollectionIntervalHours`设置采集间隔为1小时，`MinRequestIntervalSeconds`确保请求间隔不低于1小时以避免被封禁。`RandomDelay`引入30-180秒的随机延迟，增加请求的隐蔽性。`DataSources`对象配置了多个数据源，如腾讯官方站和DD373，可启用/禁用并设置优先级。

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L10-L75)
- [DataCollectionConfiguration.cs](file://src/POE2Finance.Services/Configuration/DataCollectionConfiguration.cs#L5-L58)

### Analysis配置节
`Analysis`节定义了市场分析的阈值。`StrongTrendThreshold`和`ModerateTrendThreshold`分别设置强势和温和趋势的百分比阈值。`HotScoreWeights`通过权重计算物品热度评分，`VolatilityWeight`、`VolumeWeight`和`TrendWeight`共同决定最终得分。

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L77-L93)
- [AnalysisConfiguration.cs](file://src/POE2Finance.Services/Configuration/AnalysisConfiguration.cs#L5-L51)

### Charts配置节
`Charts`节配置图表生成参数。`Width`和`Height`设置为1920x1080的全高清分辨率。`CurrencyColors`定义了不同通货的颜色，如崇高石为金色(`#FFD700`)，神圣石为紫色(`#8A2BE2`)。`Output`配置输出质量、DPI和水印。

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L95-L113)
- [ChartConfiguration.cs](file://src/POE2Finance.Services/Configuration/ChartConfiguration.cs#L5-L86)

### Bilibili配置节
`Bilibili`节控制B站视频发布。`Enabled`开关控制是否发布。`SessionCookie`和`CsrfToken`是发布视频必需的认证信息。`PublishingStrategy`中的`EnableScheduledPublish`可设置定时发布，`ScheduledPublish`配置了上午、下午和晚间三个发布时间点。

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L129-L130)
- [BilibiliConfiguration.cs](file://src/POE2Finance.Services/Configuration/BilibiliConfiguration.cs#L5-L71)

### 其他配置节
`ContentGeneration`节的`EnableAiGeneration`控制是否使用AI生成内容。`EdgeTts`节配置语音合成，`VoiceName`指定使用`zh-CN-XiaoxiaoNeural`中文女声。`Video`节的`SegmentDurations`精确控制视频各段落时长，如开场5秒，每个图表展示10秒。

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L115-L128)
- [ContentGenerationConfiguration.cs](file://src/POE2Finance.Services/Configuration/ContentGenerationConfiguration.cs#L5-L303)
- [VideoConfiguration.cs](file://src/POE2Finance.Services/Configuration/VideoConfiguration.cs#L5-L437)

## 环境变量覆盖

环境变量可覆盖`appsettings.json`中的配置，优先级最高。在`docker-compose.yml`的`environment`部分或`.env`文件中设置。

### 关键环境变量
- `ASPNETCORE_ENVIRONMENT`: 设置为`Development`或`Production`，影响日志级别和错误显示。
- `ASPNETCORE_URLS`: 指定应用监听的URL，如`http://+:8080`。
- `BILIBILI_SESSION_COOKIE`和`BILIBILI_CSRF_TOKEN`: 用于覆盖B站认证信息，避免将敏感信息硬编码在配置文件中。
- `LOG_LEVEL`: 覆盖日志级别，如设置为`Debug`以获取更详细的日志。

### 覆盖机制
在`Program.cs`中，`builder.Configuration`会按优先级加载配置：命令行参数 > 环境变量 > `appsettings.json`。因此，环境变量中的`ASPNETCORE_ENVIRONMENT=Production`会覆盖`appsettings.json`中的设置。

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L15-L18)
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L120-L135)
- [Program.cs](file://src/POE2Finance.Web/Program.cs#L1-L145)

## 多环境配置最佳实践

### 开发环境
开发环境应启用Swagger和详细日志。在`appsettings.Development.json`中设置`Logging.LogLevel.Default`为`Debug`，并确保`ASPNETCORE_ENVIRONMENT`为`Development`。禁用B站发布（`Bilibili.Enabled=false`）以避免误发。

### 生产环境
生产环境应使用`appsettings.Production.json`或环境变量进行配置。数据库连接字符串应指向持久化数据库文件（如`Data Source=/app/data/poe2finance.db`）。启用B站发布，并配置正确的`SessionCookie`和`CsrfToken`。日志级别设置为`Information`或`Warning`以减少日志量。

### 配置文件分离
遵循ASP.NET Core惯例，使用`appsettings.{Environment}.json`文件进行环境特定配置。通用配置保留在`appsettings.json`中，环境特定配置（如数据库连接、API密钥）放在环境文件中，并通过`.gitignore`排除，防止敏感信息泄露。

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L40-L75)
- [Program.cs](file://src/POE2Finance.Web/Program.cs#L68-L75)

## 健康检查与监控

### 内置健康检查
应用通过`HEALTHCHECK`指令和`/health`端点提供健康检查。Docker会定期调用`curl -f http://localhost:8080/health`，返回200状态码表示健康。此端点由ASP.NET Core的健康检查中间件提供。

### 日志监控
使用Serilog进行日志记录，配置输出到控制台和文件。日志文件位于`/app/logs`目录，按天滚动，保留7天。通过`docker-compose logs -f poe2finance`可实时查看日志。`Serilog.WriteTo.File`的`outputTemplate`包含时间戳、日志级别和异常信息，便于排查问题。

### 系统监控
建议使用`docker stats`监控容器资源使用情况。结合`htop`、`df -h`等系统命令监控CPU、内存和磁盘。对于生产环境，可集成Prometheus和Grafana进行可视化监控。

**Section sources**
- [Dockerfile](file://Dockerfile#L65-L67)
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L114-L128)
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L220-L235)