# 配置管理

<cite>
**本文档引用的文件**  
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json)
- [DEPLOYMENT.md](file://DEPLOYMENT.md)
- [AnalysisConfiguration.cs](file://src/POE2Finance.Services/Configuration/AnalysisConfiguration.cs)
- [BilibiliConfiguration.cs](file://src/POE2Finance.Services/Configuration/BilibiliConfiguration.cs)
- [ChartConfiguration.cs](file://src/POE2Finance.Services/Configuration/ChartConfiguration.cs)
- [ContentGenerationConfiguration.cs](file://src/POE2Finance.Services/Configuration/ContentGenerationConfiguration.cs)
- [DataCollectionConfiguration.cs](file://src/POE2Finance.Services/Configuration/DataCollectionConfiguration.cs)
- [VideoConfiguration.cs](file://src/POE2Finance.Services/Configuration/VideoConfiguration.cs)
</cite>

## 目录

1. [配置文件概述](#配置文件概述)
2. [核心配置节详解](#核心配置节详解)
   - [连接字符串](#连接字符串)
   - [日志配置 (Serilog)](#日志配置-serilog)
   - [数据采集配置](#数据采集配置)
   - [价格分析配置](#价格分析配置)
   - [图表生成配置](#图表生成配置)
   - [内容生成配置](#内容生成配置)
   - [Edge-TTS语音合成配置](#edge-tts语音合成配置)
   - [视频制作配置](#视频制作配置)
   - [B站发布配置](#b站发布配置)
3. [环境变量覆盖机制](#环境变量覆盖机制)
4. [生产环境配置](#生产环境配置)
5. [配置实践指南](#配置实践指南)

## 配置文件概述

`appsettings.json` 是 POE2Finance 应用的核心配置文件，位于 `src/POE2Finance.Web/` 目录下。该文件采用 JSON 格式组织，包含多个配置节，每个节对应应用的不同功能模块。配置文件的设计遵循了模块化原则，将不同功能的配置分离到独立的节中，便于管理和维护。

配置文件中的每个配置节都与服务层中的一个配置类相对应，通过依赖注入机制将配置值注入到相应的服务中。这种设计模式实现了配置与代码的解耦，使得配置变更无需修改代码即可生效。

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L1-L130)

## 核心配置节详解

### 连接字符串

连接字符串配置节定义了应用与数据库的连接信息。当前配置使用 SQLite 数据库，文件名为 `poe2finance.db`，位于应用根目录下。

```json
"ConnectionStrings": {
  "DefaultConnection": "Data Source=poe2finance.db"
}
```

此配置指定了默认数据库连接字符串。在生产环境中，可以通过环境变量或专用的生产配置文件来覆盖此设置，指向更可靠的数据库系统。

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L10-L12)

### 日志配置 (Serilog)

日志配置节使用 Serilog 作为日志框架，定义了日志的输出目标、级别和格式。

```json
"Serilog": {
  "Using": ["Serilog.Sinks.Console", "Serilog.Sinks.File"],
  "MinimumLevel": {
    "Default": "Information",
    "Override": {
      "Microsoft": "Warning",
      "System": "Warning",
      "Quartz": "Information"
    }
  },
  "WriteTo": [
    { "Name": "Console" },
    {
      "Name": "File",
      "Args": {
        "path": "logs/poe2finance-.log",
        "rollingInterval": "Day",
        "retainedFileCountLimit": 7,
        "outputTemplate": "{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} [{Level:u3}] {Message:lj}{NewLine}{Exception}"
      }
    }
  ]
}
```

配置说明：
- **Using**: 指定使用的 Serilog 接收器，包括控制台和文件
- **MinimumLevel**: 设置最低日志级别，可针对不同命名空间进行重写
- **WriteTo**: 定义日志输出目标，支持滚动文件和格式化模板

日志文件按天滚动，保留最近7天的日志，便于日志管理和磁盘空间控制。

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L120-L130)

### 数据采集配置

数据采集配置节定义了从多个数据源采集游戏货币价格的策略和参数。

```json
"DataCollection": {
  "CollectionIntervalHours": 1,
  "MinRequestIntervalSeconds": 3600,
  "RandomDelay": {
    "MinSeconds": 30,
    "MaxSeconds": 180
  },
  "RequestTimeoutSeconds": 30,
  "MaxRetries": 3,
  "RetryDelayBaseSeconds": 5,
  "UserAgents": [
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/121.0"
  ],
  "DataSources": {
    "TencentOfficial": {
      "Enabled": true,
      "Priority": 1,
      "BaseUrl": "https://poe2.qq.com",
      "TradeApiEndpoint": "/api/trade",
      "Headers": {
        "Accept": "application/json, text/plain, */*",
        "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
        "Referer": "https://poe2.qq.com/trade"
      }
    },
    "DD373": {
      "Enabled": true,
      "Priority": 2,
      "BaseUrl": "https://www.dd373.com",
      "Poe2Section": "/poe2"
    }
  }
}
```

配置说明：
- **CollectionIntervalHours**: 采集间隔，每1小时执行一次采集任务
- **MinRequestIntervalSeconds**: 最小请求间隔，防止过于频繁的请求
- **RandomDelay**: 添加随机延迟（30-180秒），模拟人类行为，避免被反爬虫机制识别
- **RequestTimeoutSeconds**: 请求超时时间，30秒后自动终止
- **MaxRetries**: 最大重试次数，采集失败时最多重试3次
- **RetryDelayBaseSeconds**: 重试延迟基数，采用指数退避策略
- **UserAgents**: User-Agent 轮换池，包含多个主流浏览器标识
- **DataSources**: 数据源配置，支持腾讯官方和DD373两个数据源，按优先级顺序采集

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L13-L55)
- [DataCollectionConfiguration.cs](file://src/POE2Finance.Services/Configuration/DataCollectionConfiguration.cs#L5-L58)

### 价格分析配置

价格分析配置节定义了市场趋势分析的阈值和权重参数。

```json
"Analysis": {
  "StrongTrendThreshold": 10.0,
  "ModerateTrendThreshold": 5.0,
  "HighVolatilityThreshold": 15.0,
  "VolumeAnomalyThreshold": 50.0,
  "MinHotScore": 30.0,
  "HotScoreWeights": {
    "VolatilityWeight": 0.4,
    "VolumeWeight": 0.35,
    "TrendWeight": 0.25
  }
}
```

配置说明：
- **StrongTrendThreshold**: 强势趋势阈值，价格变化超过10%视为强势趋势
- **ModerateTrendThreshold**: 温和趋势阈值，价格变化超过5%视为温和趋势
- **HighVolatilityThreshold**: 高波动率阈值，波动率超过15%视为高波动
- **VolumeAnomalyThreshold**: 交易量异常变化阈值，交易量变化超过50%视为异常
- **MinHotScore**: 热点物品最小热度评分，用于筛选热门物品
- **HotScoreWeights**: 热度评分权重，由波动率(40%)、交易量(35%)和趋势(25%)加权计算

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L56-L66)
- [AnalysisConfiguration.cs](file://src/POE2Finance.Services/Configuration/AnalysisConfiguration.cs#L5-L51)

### 图表生成配置

图表生成配置节定义了生成价格图表的视觉参数。

```json
"Charts": {
  "Width": 1920,
  "Height": 1080,
  "LineWidth": 2.0,
  "MarkerSize": 5.0,
  "TitleFontSize": 16.0,
  "AxisLabelFontSize": 12.0,
  "BackgroundColor": "#FFFFFF",
  "PlotBackgroundColor": "#F8F8F8",
  "GridColor": "#E0E0E0"
}
```

配置说明：
- **Width/Height**: 图表尺寸，1920x1080像素，符合全高清标准
- **LineWidth**: 线条宽度，2.0像素
- **MarkerSize**: 数据点标记大小，5.0像素
- **TitleFontSize**: 标题字体大小，16.0像素
- **AxisLabelFontSize**: 坐标轴标签字体大小，12.0像素
- **BackgroundColor**: 背景颜色，白色
- **PlotBackgroundColor**: 绘图区背景颜色，浅灰色
- **GridColor**: 网格线颜色，淡灰色

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L67-L77)
- [ChartConfiguration.cs](file://src/POE2Finance.Services/Configuration/ChartConfiguration.cs#L5-L86)

### 内容生成配置

内容生成配置节控制AI内容生成功能的开关。

```json
"ContentGeneration": {
  "EnableAiGeneration": true
}
```

配置说明：
- **EnableAiGeneration**: 是否启用AI内容生成，`true` 表示启用，`false` 表示禁用

当启用时，系统将使用AI模型自动生成视频标题、描述和标签；禁用时则使用预设模板或手动输入的内容。

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L78-L80)
- [ContentGenerationConfiguration.cs](file://src/POE2Finance.Services/Configuration/ContentGenerationConfiguration.cs#L5-L36)

### Edge-TTS语音合成配置

Edge-TTS语音合成配置节定义了语音合成的参数。

```json
"EdgeTts": {
  "EdgeTtsCommand": "edge-tts",
  "VoiceName": "zh-CN-XiaoxiaoNeural",
  "Rate": "+10%",
  "Volume": "+0%",
  "Pitch": "+0Hz",
  "TimeoutSeconds": 300,
  "MaxRetries": 3
}
```

配置说明：
- **EdgeTtsCommand**: Edge-TTS命令行工具名称
- **VoiceName**: 音色名称，使用中文晓晓神经网络音色
- **Rate**: 语速，比正常快10%
- **Volume**: 音量，正常音量
- **Pitch**: 音调，正常音调
- **TimeoutSeconds**: 超时时间，300秒
- **MaxRetries**: 最大重试次数，3次

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L81-L90)

### 视频制作配置

视频制作配置节定义了视频生成的技术参数。

```json
"Video": {
  "Width": 1920,
  "Height": 1080,
  "FrameRate": 30.0,
  "VideoBitrate": 5000,
  "AudioBitrate": 128,
  "CrfValue": 23,
  "SegmentDurations": {
    "OpeningDuration": 5,
    "ChartDisplayDuration": 10,
    "HotItemsAnalysisDuration": 15,
    "MarketSummaryDuration": 8,
    "EndingDuration": 2
  }
}
```

配置说明：
- **Width/Height**: 视频分辨率，1920x1080
- **FrameRate**: 帧率，30fps
- **VideoBitrate**: 视频码率，5000kbps
- **AudioBitrate**: 音频码率，128kbps
- **CrfValue**: CRF质量参数，23为视觉无损质量
- **SegmentDurations**: 分段时长配置，定义了视频各部分的持续时间

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L91-L105)
- [VideoConfiguration.cs](file://src/POE2Finance.Services/Configuration/VideoConfiguration.cs#L5-L86)

### B站发布配置

B站发布配置节定义了向B站发布视频的相关参数。

```json
"Bilibili": {
  "Enabled": false,
  "ApiBaseUrl": "https://member.bilibili.com/x",
  "SessionCookie": "",
  "CsrfToken": "",
  "CategoryId": 4,
  "ChunkSize": 4194304,
  "UploadTimeoutSeconds": 3600,
  "MaxRetries": 3
}
```

配置说明：
- **Enabled**: 是否启用B站发布功能
- **ApiBaseUrl**: B站API基础URL
- **SessionCookie**: 会话Cookie，包含SESSDATA等认证信息
- **CsrfToken**: CSRF令牌，用于防止跨站请求伪造
- **CategoryId**: 分区ID，4代表游戏区
- **ChunkSize**: 分片上传大小，4MB
- **UploadTimeoutSeconds**: 上传超时时间，1小时
- **MaxRetries**: 最大重试次数，3次

**Section sources**
- [appsettings.json](file://src/POE2Finance.Web/appsettings.json#L106-L118)
- [BilibiliConfiguration.cs](file://src/POE2Finance.Services/Configuration/BilibiliConfiguration.cs#L5-L71)

## 环境变量覆盖机制

POE2Finance 支持通过环境变量覆盖配置文件中的设置。环境变量的优先级高于配置文件，允许在不同部署环境中灵活调整配置而无需修改配置文件。

环境变量的命名规则为：将配置节和配置项用双下划线(`__`)连接。例如：

- `ConnectionStrings__DefaultConnection` 覆盖数据库连接字符串
- `DataCollection__CollectionIntervalHours` 覆盖采集间隔
- `Bilibili__Enabled` 覆盖B站发布开关

在 `DEPLOYMENT.md` 中提供了环境变量配置示例：

```bash
# 应用配置
ASPNETCORE_ENVIRONMENT=Production
ASPNETCORE_URLS=http://+:8080

# 数据库配置
DB_CONNECTION_STRING=Data Source=/app/data/poe2finance.db

# B站配置（需要实际获取）
BILIBILI_SESSION_COOKIE=your_session_cookie_here
BILIBILI_CSRF_TOKEN=your_csrf_token_here

# 日志级别
LOG_LEVEL=Information
```

这些环境变量可以在Docker容器、Kubernetes Pod或系统环境中设置，实现配置的动态化管理。

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L100-L120)

## 生产环境配置

生产环境配置通过专用的 `appsettings.Production.json` 文件实现。该文件位于 `src/POE2Finance.Web/` 目录下，其配置会覆盖 `appsettings.json` 中的相应设置。

根据 `DEPLOYMENT.md` 中的示例，生产环境配置示例如下：

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=/app/data/poe2finance.db"
  },
  "DataCollection": {
    "CollectionIntervalHours": 1,
    "MinRequestIntervalSeconds": 3600
  },
  "Bilibili": {
    "Enabled": true,
    "SessionCookie": "your-bilibili-session-cookie",
    "CsrfToken": "your-csrf-token"
  }
}
```

生产环境配置的关键点：
- **数据库路径**: 使用绝对路径 `/app/data/poe2finance.db`，确保数据持久化
- **B站认证**: 启用B站发布功能，并配置实际的会话Cookie和CSRF令牌
- **日志级别**: 设置合理的日志级别，平衡调试信息和性能开销

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L25-L55)

## 配置实践指南

### B站认证信息配置

根据 `DEPLOYMENT.md` 的指导，正确配置B站认证信息的步骤如下：

1. **获取会话Cookie和CSRF令牌**:
   - 登录B站账号
   - 打开浏览器开发者工具
   - 在网络请求中找到任意API请求
   - 复制请求头中的Cookie（包含SESSDATA）和CSRF令牌

2. **配置方式**:
   - 方式一：直接在 `appsettings.Production.json` 中填写
   ```json
   "Bilibili": {
     "Enabled": true,
     "SessionCookie": "your-session-cookie",
     "CsrfToken": "your-csrf-token"
  